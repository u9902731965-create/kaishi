# Web查账系统使用指南

## 功能概述

Web查账系统为Telegram财务Bot提供了强大的Web界面，支持：

✅ **交易记录查询** - 查看所有入金/出金/下发记录  
✅ **日期筛选** - 按日期范围查询交易  
✅ **操作员统计** - 按操作员分类统计数据  
✅ **数据可视化** - 清晰的统计图表展示  
✅ **交易回退** - OWNER专属权限，可回退错误交易  
✅ **安全认证** - Token加密，24小时有效期

---

## 如何访问

### 方法1：群组内查看账单（推荐）

1. 在Telegram群组中发送任意交易命令（如 `+0` 查看账单）
2. Bot会回复账单汇总，并附带 **"📊 查看账单明细"** 按钮
3. 点击按钮即可打开Web查账界面

### 方法2：私聊Bot

1. 私聊Bot发送 `+0` 或 `更多记录`
2. Bot回复中同样包含Web查账按钮
3. 点击按钮访问

---

## 功能详解

### 1. 筛选面板

**日期筛选**：
- 默认显示最近7天的记录
- 可自定义开始/结束日期
- 点击"查询"按钮应用筛选
- 点击"重置"恢复默认

### 2. 统计面板

实时显示4个关键指标：

| 指标 | 说明 |
|------|------|
| **总入金** | 所有入金交易的总额（原始金额 + USDT） |
| **总出金** | 所有出金交易的总额（原始金额 + USDT） |
| **已下发** | 已完成的USDT下发总额 |
| **应下发** | 应下发 = 总入金USDT - 总出金USDT - 已下发 |

### 3. 当前配置

显示群组的当前费率和汇率设置：
- 入金费率/汇率
- 出金费率/汇率

### 4. 交易记录表格

**表格列说明**：
- **时间** - 交易发生的精确时间
- **类型** - 入金/出金/下发（带颜色标记）
- **金额** - 原始金额（人民币等）
- **费率** - 交易时使用的费率（百分比）
- **汇率** - 交易时使用的汇率
- **USDT** - 计算后的USDT金额
- **操作员** - 执行交易的管理员

**OWNER专属功能**：
- 额外显示"操作"列
- 每笔交易有"🔄 回退"按钮
- 点击后需要二次确认

### 5. 按操作员统计

按管理员分类汇总：
- 入金笔数 / 入金USDT
- 出金笔数 / 出金USDT
- 下发笔数 / 下发USDT

便于团队绩效分析和对账。

### 6. 交易回退（仅OWNER）

**⚠️ 危险操作，仅OWNER可用**

**功能说明**：
- 可回退任意入金/出金/下发交易
- 回退后立即从记录中删除
- **不可撤销！**

**操作步骤**：
1. 在交易记录表格中找到要回退的交易
2. 点击"🔄 回退"按钮
3. 确认对话框中再次确认
4. 点击"确认回退"

**注意事项**：
- 回退操作会直接修改群组数据文件
- 回退后统计数据会自动重新计算
- 建议仅在输入错误时使用

---

## 技术细节

### Token安全机制

**生成规则**：
```
token = chat_id:user_id:expires_at:signature
signature = HMAC-SHA256(chat_id:user_id:expires_at, SECRET_KEY)
```

**安全特性**：
- 24小时自动过期
- HMAC签名防篡改
- 每个用户独立token
- 仅能访问所属群组数据

### 部署配置

**环境变量**：

| 变量 | 说明 | 示例 |
|------|------|------|
| `TELEGRAM_BOT_TOKEN` | Bot Token | `123456:ABC-DEF...` |
| `OWNER_ID` | 管理员Telegram ID | `7784416293` |
| `SESSION_SECRET` | Token加密密钥 | 自动生成或自定义 |
| `WEB_BASE_URL` | Web应用公网URL | `https://your-domain.com` |
| `PORT` | Bot健康检查端口 | `10000` |
| `WEB_PORT` | Web应用端口 | `5000` |

**Docker部署**：

```bash
docker run -d \
  -p 10000:10000 \
  -p 5000:5000 \
  -e TELEGRAM_BOT_TOKEN="your-token" \
  -e OWNER_ID="your-id" \
  -e WEB_BASE_URL="https://your-domain.com" \
  -e SESSION_SECRET="your-secret" \
  your-image:latest
```

**ClawCloud配置**：
- Container Port: `5000` （Web端口）
- Public Access: ✅ 开启
- 添加所有环境变量

---

## 数据存储

**文件位置**：
```
data/
  groups/
    group_-1001234567890.json  # 各群组独立数据
    group_-111222333.json
  logs/                          # 日志文件（可选）
```

**数据格式**（JSON）：
```json
{
  "defaults": {
    "in": {"rate": 0.1, "fx": 153},
    "out": {"rate": 0.02, "fx": 137}
  },
  "deposit_records": [
    {
      "time": "2025-11-02 14:30:00",
      "amount": 10000,
      "usdt": 58.48,
      "fee_rate": 0.1,
      "fx": 153,
      "operator": "张三",
      "message_id": 12345
    }
  ],
  "withdrawal_records": [...],
  "disbursement_records": [...]
}
```

---

## 常见问题

### Q: Token过期怎么办？
A: 重新在Telegram中点击"查看账单明细"按钮获取新token。

### Q: 能否同时查看多个群组？
A: 不可以，每个token绑定一个群组，需要分别访问。

### Q: 回退操作能否撤销？
A: **不能！** 回退是永久操作，请谨慎使用。

### Q: 普通管理员能看到Web界面吗？
A: 可以！所有管理员都能查看，但只有OWNER能执行回退操作。

### Q: 数据会丢失吗？
A: ClawCloud环境下数据持久化，除非手动删除容器。

### Q: 手机能访问吗？
A: 完全支持！界面采用响应式设计，手机/平板/电脑都能完美显示。

---

## 更新日志

**2025-11-02**:
- ✅ 初始版本发布
- ✅ 实现完整查账功能
- ✅ Token认证系统
- ✅ 交易回退功能
- ✅ 响应式UI设计

---

## 技术支持

如有问题，请联系开发者或在GitHub提Issue。

**项目地址**: https://github.com/ale01icloud/tron-calculator-rental
