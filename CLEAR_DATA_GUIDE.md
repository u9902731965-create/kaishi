# "清除数据"命令使用指南

## 📋 功能概述

"清除数据"命令允许管理员快速清除今日（北京时间00:00）至当前时间的所有交易数据，并自动重新计算账单汇总。

---

## 🔑 权限要求

**仅机器人管理员可用**

- ✅ 超级管理员（OWNER_ID）
- ✅ 机器人管理员（通过"设置机器人管理员"命令授权）
- ❌ 普通群成员

---

## 💡 使用场景

### 场景1：测试数据清理
录入了一些测试交易数据后，想要清除这些测试记录。

### 场景2：错误批量数据
不小心录入了多笔错误数据，逐一撤销太麻烦。

### 场景3：重新开始记账
想要从当前时刻重新开始记账，清除之前的所有数据。

---

## 🚀 使用方法

### 基础用法

在Telegram群组中发送：

```
清除数据
```

### 执行流程

1. **发送命令** → Bot接收"清除数据"指令
2. **权限验证** → 检查是否为管理员
3. **数据筛选** → 筛选今日00:00至现在的所有记录
4. **清除数据** → 删除符合条件的记录
5. **重新计算** → 自动计算新的应下发/已下发金额
6. **显示结果** → 返回清除统计和新账单

---

## 📊 清除范围

命令会清除以下三类数据：

### 1. 已入账（入金记录）
- 清除所有入金交易
- 格式示例：`+10000`、`+5000 / 日本`

### 2. 已出账（出金记录）
- 清除所有出金交易
- 格式示例：`-10000`、`-5000 / 美国`

### 3. 已下发（USDT下发记录）
- 清除所有USDT下发记录
- 格式示例：`下发35.04`、`下发-35.04`

---

## ⏰ 时间范围

**清除范围：今日00:00（北京时间）至输入命令的当前时间**

### 示例

假设现在是 **2025-11-05 14:30**（北京时间）：

- ✅ **会清除**：2025-11-05 00:00 - 14:30 的所有数据
- ❌ **不会清除**：2025-11-04 及之前的数据

### 重要说明

- ⚠️ **每日重置功能不受影响**：Bot仍会在每天00:00自动重置
- ⚠️ **历史数据保留**：昨天及之前的数据不会被清除
- ⚠️ **不可撤销**：清除操作无法撤销，请谨慎使用

---

## 📈 示例输出

### 有数据时

```
✅ 已清除今日数据（00:00至现在）

📥 已入账：清除 5 笔 (150.00 USDT)
📤 已出账：清除 3 笔 (80.50 USDT)
💰 已下发：清除 2 笔 (60.00 USDT)

━━━━━━━━━━━━━━
📊 重新计算后：
  • 应下发：0.00 USDT
  • 已下发：0.00 USDT
  • 未下发：0.00 USDT
```

### 无数据时

```
ℹ️ 今日00:00之后暂无数据
📊 无需清除
```

---

## 🔄 数据重算逻辑

清除数据后，Bot会自动重新计算：

### 计算公式

```
应下发USDT = 剩余入金记录的USDT总和
已下发USDT = 剩余出金记录的USDT总和 + 剩余下发记录的USDT总和
未下发USDT = 应下发USDT - 已下发USDT
```

### 示例

**清除前：**
- 入金记录：10笔（共300 USDT）
- 出金记录：5笔（共150 USDT）
- 下发记录：3笔（共100 USDT）
- 应下发：300 USDT
- 已下发：250 USDT
- 未下发：50 USDT

**清除今日数据后（假设今日有7笔入金、3笔出金、2笔下发）：**
- 入金记录：3笔（共100 USDT）
- 出金记录：2笔（共50 USDT）
- 下发记录：1笔（共30 USDT）
- 应下发：100 USDT ✅ 重新计算
- 已下发：80 USDT ✅ 重新计算
- 未下发：20 USDT ✅ 重新计算

---

## 📝 日志记录

所有清除操作都会记录到日志文件：

```
[清除数据] 时间:2025-11-05 14:30 清除入金:5笔/150.00USDT 出金:3笔/80.50USDT 下发:2笔/60.00USDT
```

日志位置：`data/logs/group_<chat_id>/`

---

## ⚠️ 注意事项

### 1. 操作不可撤销
一旦清除，数据无法恢复。建议：
- 清除前先发送 `+0` 查看账单截图保存
- 确认无误后再执行清除操作

### 2. 权限控制
只有管理员可以执行，普通成员发送命令不会有任何响应。

### 3. 时间范围
只清除**今日00:00之后**的数据，不会影响历史数据。

### 4. 不影响配置
清除数据**不会**重置：
- ❌ 费率设置（入金费率、出金费率）
- ❌ 汇率设置（入金汇率、出金汇率）
- ❌ 国家专属设置
- ❌ 管理员列表

### 5. 与"重置默认值"的区别

| 命令 | 清除数据 | 重置默认值 |
|------|---------|-----------|
| 功能 | 清除交易记录 | 重置费率/汇率 |
| 影响范围 | 已入账、已出账、已下发 | 入金/出金费率和汇率 |
| 是否可撤销 | 不可撤销 | 可重新设置 |

---

## 🔄 完整操作流程示例

### 步骤1：查看当前账单

```
用户：+0
Bot：【账单汇总】
     已入账 (8笔)
     已出账 (4笔)
     已下发 (2笔)
     应下发：200.00 USDT
     已下发：150.00 USDT
     未下发：50.00 USDT
```

### 步骤2：发送清除命令

```
用户：清除数据
```

### 步骤3：查看清除结果

```
Bot：✅ 已清除今日数据（00:00至现在）
     
     📥 已入账：清除 8 笔 (200.00 USDT)
     📤 已出账：清除 4 笔 (120.00 USDT)
     💰 已下发：清除 2 笔 (30.00 USDT)
     
     ━━━━━━━━━━━━━━
     📊 重新计算后：
       • 应下发：0.00 USDT
       • 已下发：0.00 USDT
       • 未下发：0.00 USDT
```

### 步骤4：自动显示新账单

```
Bot：📊【AA全球国际支付 账单汇总】
     
     已入账 (0笔)
     
     已出账 (0笔)
     
     ━━━━━━━━━━━━━━
     ⚙️ 当前费率：入 10% ⇄ 出 2%
     💱 固定汇率：入 153 ⇄ 出 137
     📊 应下发：0.00 USDT
     📤 已下发：0.00 USDT
     ✅ 未下发：0.00 USDT
```

---

## 💡 最佳实践

### 1. 清除前备份
```
1. 发送 +0 查看账单
2. 截图保存
3. 确认无误后执行清除
```

### 2. 定期清理测试数据
```
每天下班前清除测试数据：
1. 清除数据
2. 检查费率/汇率设置是否正确
3. 重新开始正式记账
```

### 3. 批量错误修正
```
发现多笔错误数据时：
1. 清除数据（快速清空）
2. 重新录入正确数据
```

---

## 🆘 常见问题

### Q1: 清除数据后费率/汇率会重置吗？
**A**: 不会！清除数据只删除交易记录，不会影响费率/汇率设置。

### Q2: 能清除昨天的数据吗？
**A**: 不能。命令只清除今日00:00之后的数据，历史数据会保留。

### Q3: 清除后能撤销吗？
**A**: 不能撤销。建议清除前截图备份账单。

### Q4: 普通成员能用这个命令吗？
**A**: 不能。只有机器人管理员才能执行清除操作。

### Q5: Web查账系统的数据也会清除吗？
**A**: 会！Bot和Web查账系统使用相同的数据源，清除后Web界面也会同步更新。

---

## 📚 相关文档

- [管理员指令大全](./管理员指令大全.md)
- [Web查账系统使用指南](./WEB_DASHBOARD_GUIDE.md)
- [部署指南](./CLAWCLOUD_WEB_DEPLOY.md)

---

## 🔐 安全建议

1. ✅ **谨慎授权**：只授予信任的人管理员权限
2. ✅ **定期审查**：定期检查管理员列表（`显示机器人管理员`）
3. ✅ **操作确认**：清除前确认数据无误
4. ✅ **日志审计**：定期查看操作日志

---

**项目地址**：https://github.com/ale01icloud/tron-calculator-rental
